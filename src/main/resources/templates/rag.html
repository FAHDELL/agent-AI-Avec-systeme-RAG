<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>RAG Search</title>
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.3/css/bootstrap.min.css">

    <style>
        body {
            background: #f5f7fa;
            font-family: "Inter", sans-serif;
        }

        .container-box {
            max-width: 900px;
            margin: 40px auto;
        }

        .card-custom {
            border: none;
            border-radius: 18px;
            background: #ffffff;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        .btn-custom {
            border-radius: 12px;
            padding: 12px 22px;
            font-weight: 600;
        }

        .form-control {
            border-radius: 12px;
            padding: 12px;
            font-size: 1rem;
        }

        .title {
            font-weight: 700;
            font-size: 1.8rem;
        }

        .response-box {
            background: #f9fafc;
            border-radius: 12px;
            padding: 20px;
            white-space: pre-line;
            line-height: 1.6;
        }

        .progress {
            border-radius: 10px;
            background: #e9ecef;
        }

        .progress-bar {
            font-weight: bold;
        }
    </style>
</head>

<body>

<div class="container-box">

    <!-- UPLOAD SECTION -->
    <div class="card p-4 mb-4 card-custom">
        <h3 class="mb-3">üìÑ Uploader un ou plusieurs fichiers PDF</h3>

        <input id="pdfInput" class="form-control mb-3" type="file" accept="application/pdf" multiple>

        <button class="btn btn-dark w-100 btn-custom" onclick="uploadPdfs()">Uploader & Indexer</button>

        <!-- Progress bar -->
        <div class="progress mt-4" style="height: 18px; display:none;" id="progressContainer">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                 style="width: 0%">0%
            </div>
        </div>

        <div id="uploadStatus" class="mt-3"></div>
    </div>


    <!-- SEARCH SECTION -->
    <div class="card p-4 mb-4 card-custom">
        <h2 class="title mb-3">üîé Poser une question</h2>

        <form method="get" th:action="@{/rag}">
            <div class="mb-3">
                <input class="form-control" type="text" name="query" th:value="${query}"
                       placeholder="√âcrivez votre question ici...">
            </div>

            <button class="btn btn-primary btn-custom w-100">Search</button>
        </form>
    </div>


    <!-- RESPONSE SECTION -->
    <div class="card p-4 card-custom">
        <h3 class="mb-3">üìù R√©ponse</h3>

        <div class="response-box" th:text="${response}">
        </div>
    </div>

</div>


<script>
    function uploadPdfs() {
        const files = document.getElementById("pdfInput").files;
        if (files.length === 0) {
            alert("Choisissez au moins un fichier PDF !");
            return;
        }

        const formData = new FormData();
        for (let f of files) {
            formData.append("files", f);
        }

        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const uploadStatus = document.getElementById("uploadStatus");

        progressContainer.style.display = "block";
        progressBar.style.width = "1%";
        progressBar.innerText = "1%";
        uploadStatus.innerHTML = "";

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/uploadPdfMultiple");

        // PROGRESS BAR UPDATE
        xhr.upload.addEventListener("progress", (event) => {
            if (event.lengthComputable) {
                const percent = Math.round((event.loaded / event.total) * 100);
                progressBar.style.width = percent + "%";
                progressBar.innerText = percent + "%";
            }
        });

        // RESULT
        xhr.onload = function () {
            if (xhr.status === 200 && xhr.responseText === "OK") {
                progressBar.style.width = "100%";
                progressBar.innerText = "100%";
                uploadStatus.innerHTML =
                    "<div class='alert alert-success'>üéâ Tous les PDF ont √©t√© index√©s avec succ√®s !</div>";
            } else {
                uploadStatus.innerHTML =
                    "<div class='alert alert-danger'>‚ùå Erreur lors de l‚Äôupload : " + xhr.responseText + "</div>";
            }
        };

        xhr.onerror = function () {
            uploadStatus.innerHTML = "<div class='alert alert-danger'>‚ùå Erreur r√©seau.</div>";
        };

        xhr.send(formData);
    }
</script>

</body>
</html>
